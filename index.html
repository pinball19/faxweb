<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>FAX送受信</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <h1>📠 FAX送信</h1>

    <label>FAX番号:</label>
    <input type="text" id="faxNumber" oninput="findCompanyByContact()">

    <label>LINE ID:</label>
    <input type="text" id="lineId" oninput="findCompanyByContact()">

    <label>メールアドレス:</label>
    <input type="text" id="email" oninput="findCompanyByContact()">

    <h3 id="companyNameDisplay">会社名: （未入力）</h3>

    <label>ファイルをアップロード（画像 or PDF）:</label>
    <input type="file" id="fileInput" accept="image/*,application/pdf">

    <button onclick="sendFax()">📤 送信</button>

    <h1>📥 受信一覧（最新順）</h1>
    <div id="faxList"></div>

    <script>
        // 🔥 Firebase 設定（自身の設定をここに）
const firebaseConfig = {
  apiKey: "AIzaSyBvANDKuDIMQiCh3DcO1CUFOoMMjiAHAfw",
  authDomain: "faxweb-1250a.firebaseapp.com",
  projectId: "faxweb-1250a",
  storageBucket: "faxweb-1250a.firebasestorage.app",
  messagingSenderId: "203122177163",
  appId: "1:203122177163:web:5f7127523ad7fb364c508e",
  measurementId: "G-72STGVJ94V"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 📤 FAX送信処理
        function sendFax() {
            const companyName = document.getElementById("companyNameDisplay").textContent.replace("会社名: ", "").trim();
            const fileInput = document.getElementById("fileInput").files[0];

            if (!companyName || companyName === "（未入力）" || !fileInput) {
                alert("会社情報が特定できないか、ファイルが選択されていません。");
                return;
            }

            // Firebase Storage にアップロード
            const storageRef = storage.ref().child(`fax_files/${Date.now()}_${fileInput.name}`);
            storageRef.put(fileInput).then(snapshot => {
                return snapshot.ref.getDownloadURL();
            }).then(downloadURL => {
                // Firestore に FAXデータを保存
                return db.collection("fax_messages").add({
                    sender: companyName,
                    recipient: companyName,  // 送信先（会社名）
                    fileUrl: downloadURL,
                    fileType: fileInput.type,
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
            }).then(() => {
                alert(`✅ ${companyName} へ FAXを送信しました！`);
            }).catch(error => {
                console.error("❌ 送信エラー:", error);
                alert("❌ 送信に失敗しました。");
            });
        }

        // 📥 Firestore から会社情報を取得し、FAX番号・LINE ID・メールが一致する会社を検索
        function findCompanyByContact() {
            const faxNumber = document.getElementById("faxNumber").value.trim();
            const lineId = document.getElementById("lineId").value.trim();
            const email = document.getElementById("email").value.trim();
            const companyNameDisplay = document.getElementById("companyNameDisplay");

            if (!faxNumber && !lineId && !email) {
                companyNameDisplay.textContent = "会社名: （未入力）";
                return;
            }

            db.collection("companies").get().then(snapshot => {
                let matchedCompanies = [];

                snapshot.forEach(doc => {
                    const data = doc.data();

                    if (
                        (faxNumber && data.faxNumber === faxNumber) ||
                        (lineId && data.lineId === lineId) ||
                        (email && data.email === email)
                    ) {
                        matchedCompanies.push(data.name);
                    }
                });

                if (matchedCompanies.length > 0) {
                    companyNameDisplay.textContent = `会社名: ${matchedCompanies.join(", ")}`;
                } else {
                    companyNameDisplay.textContent = "会社名: （該当なし）";
                }
            }).catch(error => {
                console.error("❌ Firestore 検索エラー:", error);
            });
        }

        // 📥 受信FAX一覧を時系列順で表示
        function loadReceivedFaxes() {
            db.collection("fax_messages").orderBy("created_at", "desc").get().then(snapshot => {
                const faxList = document.getElementById("faxList");
                faxList.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let fileDisplay = "";

                    if (data.fileType === "application/pdf") {
                        const canvasId = `pdfCanvas_${doc.id}`;
                        fileDisplay = `
                            <canvas id="${canvasId}" width="150"></canvas>
                            <br><a href="${data.fileUrl}" target="_blank">📄 PDFを開く</a>
                        `;
                        setTimeout(() => {
                            renderPDFThumbnail(data.fileUrl, canvasId);
                        }, 500);
                    } else {
                        fileDisplay = `<img src="${data.fileUrl}" width="150">`;
                    }

                    faxList.innerHTML += `
                        <div>
                            <strong>送信元:</strong> ${data.sender} <br>
                            <strong>送信先:</strong> ${data.recipient} <br>
                            ${fileDisplay}
                            <hr>
                        </div>
                    `;
                });
            });
        }

        // 🔥 PDFサムネイル生成
        function renderPDFThumbnail(pdfUrl, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
                return pdf.getPage(1);
            }).then(page => {
                const viewport = page.getViewport({ scale: 0.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                return page.render(renderContext);
            }).catch(error => {
                console.error("❌ PDFサムネイル生成エラー:", error);
            });
        }

        // 📥 ページロード時にFAX受信データを読み込む
        loadReceivedFaxes();
    </script>
</body>
</html>
