<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>FAXé€å—ä¿¡</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <h1>ğŸ“  FAXé€ä¿¡</h1>

    <label>FAXç•ªå·:</label>
    <input type="text" id="faxNumber" oninput="findCompanyByContact()">

    <label>LINE ID:</label>
    <input type="text" id="lineId" oninput="findCompanyByContact()">

    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
    <input type="text" id="email" oninput="findCompanyByContact()">

    <h3 id="companyNameDisplay">ä¼šç¤¾å: ï¼ˆæœªå…¥åŠ›ï¼‰</h3>

    <label>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒ or PDFï¼‰:</label>
    <input type="file" id="fileInput" accept="image/*,application/pdf">

    <button onclick="sendFax()">ğŸ“¤ é€ä¿¡</button>

    <h1>ğŸ“¥ å—ä¿¡ä¸€è¦§ï¼ˆæœ€æ–°é †ï¼‰</h1>
    <div id="faxList"></div>

    <script>
        // ğŸ”¥ Firebase è¨­å®šï¼ˆè‡ªèº«ã®è¨­å®šã‚’ã“ã“ã«ï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyBvANDKuDIMQiCh3DcO1CUFOoMMjiAHAfw",
  authDomain: "faxweb-1250a.firebaseapp.com",
  projectId: "faxweb-1250a",
  storageBucket: "faxweb-1250a.firebasestorage.app",
  messagingSenderId: "203122177163",
  appId: "1:203122177163:web:5f7127523ad7fb364c508e",
  measurementId: "G-72STGVJ94V"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ğŸ“¤ FAXé€ä¿¡å‡¦ç†
        function sendFax() {
            const companyName = document.getElementById("companyNameDisplay").textContent.replace("ä¼šç¤¾å: ", "").trim();
            const fileInput = document.getElementById("fileInput").files[0];

            if (!companyName || companyName === "ï¼ˆæœªå…¥åŠ›ï¼‰" || !fileInput) {
                alert("ä¼šç¤¾æƒ…å ±ãŒç‰¹å®šã§ããªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            // Firebase Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const storageRef = storage.ref().child(`fax_files/${Date.now()}_${fileInput.name}`);
            storageRef.put(fileInput).then(snapshot => {
                return snapshot.ref.getDownloadURL();
            }).then(downloadURL => {
                // Firestore ã« FAXãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                return db.collection("fax_messages").add({
                    sender: companyName,
                    recipient: companyName,  // é€ä¿¡å…ˆï¼ˆä¼šç¤¾åï¼‰
                    fileUrl: downloadURL,
                    fileType: fileInput.type,
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
            }).then(() => {
                alert(`âœ… ${companyName} ã¸ FAXã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`);
            }).catch(error => {
                console.error("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                alert("âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
        }

        // ğŸ“¥ Firestore ã‹ã‚‰ä¼šç¤¾æƒ…å ±ã‚’å–å¾—ã—ã€FAXç•ªå·ãƒ»LINE IDãƒ»ãƒ¡ãƒ¼ãƒ«ãŒä¸€è‡´ã™ã‚‹ä¼šç¤¾ã‚’æ¤œç´¢
        function findCompanyByContact() {
            const faxNumber = document.getElementById("faxNumber").value.trim();
            const lineId = document.getElementById("lineId").value.trim();
            const email = document.getElementById("email").value.trim();
            const companyNameDisplay = document.getElementById("companyNameDisplay");

            if (!faxNumber && !lineId && !email) {
                companyNameDisplay.textContent = "ä¼šç¤¾å: ï¼ˆæœªå…¥åŠ›ï¼‰";
                return;
            }

            db.collection("companies").get().then(snapshot => {
                let matchedCompanies = [];

                snapshot.forEach(doc => {
                    const data = doc.data();

                    if (
                        (faxNumber && data.faxNumber === faxNumber) ||
                        (lineId && data.lineId === lineId) ||
                        (email && data.email === email)
                    ) {
                        matchedCompanies.push(data.name);
                    }
                });

                if (matchedCompanies.length > 0) {
                    companyNameDisplay.textContent = `ä¼šç¤¾å: ${matchedCompanies.join(", ")}`;
                } else {
                    companyNameDisplay.textContent = "ä¼šç¤¾å: ï¼ˆè©²å½“ãªã—ï¼‰";
                }
            }).catch(error => {
                console.error("âŒ Firestore æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
            });
        }

        // ğŸ“¥ å—ä¿¡FAXä¸€è¦§ã‚’æ™‚ç³»åˆ—é †ã§è¡¨ç¤º
        function loadReceivedFaxes() {
            db.collection("fax_messages").orderBy("created_at", "desc").get().then(snapshot => {
                const faxList = document.getElementById("faxList");
                faxList.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let fileDisplay = "";

                    if (data.fileType === "application/pdf") {
                        const canvasId = `pdfCanvas_${doc.id}`;
                        fileDisplay = `
                            <canvas id="${canvasId}" width="150"></canvas>
                            <br><a href="${data.fileUrl}" target="_blank">ğŸ“„ PDFã‚’é–‹ã</a>
                        `;
                        setTimeout(() => {
                            renderPDFThumbnail(data.fileUrl, canvasId);
                        }, 500);
                    } else {
                        fileDisplay = `<img src="${data.fileUrl}" width="150">`;
                    }

                    faxList.innerHTML += `
                        <div>
                            <strong>é€ä¿¡å…ƒ:</strong> ${data.sender} <br>
                            <strong>é€ä¿¡å…ˆ:</strong> ${data.recipient} <br>
                            ${fileDisplay}
                            <hr>
                        </div>
                    `;
                });
            });
        }

        // ğŸ”¥ PDFã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
        function renderPDFThumbnail(pdfUrl, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
                return pdf.getPage(1);
            }).then(page => {
                const viewport = page.getViewport({ scale: 0.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                return page.render(renderContext);
            }).catch(error => {
                console.error("âŒ PDFã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
            });
        }

        // ğŸ“¥ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«FAXå—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        loadReceivedFaxes();
    </script>
</body>
</html>
