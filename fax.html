<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>FAXé€å—ä¿¡ï¼ˆä¼šç¤¾å°‚ç”¨ï¼‰</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- PDFã®ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆç”¨ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
    #filePreview img, #filePreview canvas {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ“  FAXé€å—ä¿¡ï¼ˆä¼šç¤¾å°‚ç”¨ï¼‰</h1>
  <h3>ç¾åœ¨ã®ä¼šç¤¾: <span id="currentCompany"></span></h3>
  <button onclick="logout()">ğŸ”² ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

  <!-- é€ä¿¡æ©Ÿèƒ½ -->
  <h1>ğŸ“  FAXé€ä¿¡</h1>
  <label>é€ä¿¡å…ˆé€£çµ¡å…ˆï¼ˆFAXç•ªå·ï¼LINE IDï¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰:</label>
  <input type="text" id="recipientContact" oninput="findRecipientByContact()">
  <h3 id="recipientCompanyName">é€ä¿¡å…ˆä¼šç¤¾å: ï¼ˆæœªå…¥åŠ›ï¼‰</h3>
  <input type="file" id="fileInput" accept="image/*,application/pdf">
  <div id="filePreview"></div>
  <button onclick="sendFax()">ğŸ“¤ é€ä¿¡</button>

  <!-- å—ä¿¡ãƒ»é€ä¿¡ä¸€è¦§ï¼ˆæœ€æ–°é †ï¼‰ -->
  <h1>ğŸ“¥ é€å—ä¿¡ä¸€è¦§ï¼ˆæœ€æ–°é †ï¼‰</h1>
  <div id="faxList"></div>

  <script>
    // ================================
    // Firebase åˆæœŸåŒ–
    // ================================
    if (!firebase.apps.length) {
      const firebaseConfig = {
        apiKey: "AIzaSyBvANDKuDIMQiCh3DcO1CUFOoMMjiAHAfw",
        authDomain: "faxweb-1250a.firebaseapp.com",
        projectId: "faxweb-1250a",
        storageBucket: "faxweb-1250a.firebasestorage.app",
        messagingSenderId: "203122177163",
        appId: "1:203122177163:web:5f7127523ad7fb364c508e",
        measurementId: "G-72STGVJ94V"
      };
      firebase.initializeApp(firebaseConfig);
    }

    const db2 = firebase.firestore();
    const storage = firebase.storage();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šå—ä¿¡ãƒ»é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒ­ã‚°ã‚¤ãƒ³ä¼šç¤¾å
    let receivedFaxes = [];
    let sentFaxes = [];
    let currentCompany = "";

    // ================================
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    // ================================
    window.onload = function() {
      const companyId = sessionStorage.getItem("loggedInCompanyId");
      const companyName = sessionStorage.getItem("loggedInCompanyName");

      if (!companyId || !companyName) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        window.location.href = "index.html";
        return;
      }
      currentCompany = companyName;
      document.getElementById("currentCompany").textContent = companyName;
      loadFaxMessages(companyName);
    };

    // ================================
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    // ================================
    function logout() {
      sessionStorage.removeItem("loggedInCompanyId");
      sessionStorage.removeItem("loggedInCompanyName");
      window.location.href = "index.html";
    }

    // ================================
    // é€ä¿¡å…ˆä¼šç¤¾ã®æ¤œç´¢ï¼ˆå˜ä¸€å…¥åŠ›ã§è¤‡æ•°æ¡ä»¶ï¼‰
    // ================================
    function findRecipientByContact() {
      const contactInput = document.getElementById("recipientContact").value.trim();
      const companyNameElem = document.getElementById("recipientCompanyName");

      if(!contactInput){
        companyNameElem.textContent = "é€ä¿¡å…ˆä¼šç¤¾å: ï¼ˆæœªå…¥åŠ›ï¼‰";
        return;
      }

      db2.collection("companies")
        .get()
        .then((snapshot) => {
          let matched = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            if (
              (data.faxNumber && data.faxNumber === contactInput) ||
              (data.lineId && data.lineId === contactInput) ||
              (data.email && data.email === contactInput)
            ) {
              matched.push(data.name);
            }
          });
          companyNameElem.textContent =
            matched.length > 0
              ? `é€ä¿¡å…ˆä¼šç¤¾å: ${matched.join(", ")}`
              : "é€ä¿¡å…ˆä¼šç¤¾å: ï¼ˆè©²å½“ãªã—ï¼‰";
        })
        .catch((err) => {
          console.error("âŒ ä¼šç¤¾æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", err);
        });
    }

    // ================================
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼‰
    // ================================
    document.getElementById("fileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      const previewDiv = document.getElementById("filePreview");
      previewDiv.innerHTML = "";
      if (!file) return;

      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
      } else if (file.type === "application/pdf") {
        // PDFã®å ´åˆã€pdf.jsã§ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ç”Ÿæˆ
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
            // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—
            pdf.getPage(1).then(function(page) {
              const viewport = page.getViewport({ scale: 1 });
              const canvas = document.createElement("canvas");
              const context = canvas.getContext("2d");
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              page.render({
                canvasContext: context,
                viewport: viewport
              }).promise.then(function() {
                previewDiv.appendChild(canvas);
              });
            });
          });
        };
        fileReader.readAsArrayBuffer(file);
      }
    });

    // ================================
    // FAXé€ä¿¡å‡¦ç†
    // ================================
    function sendFax() {
      const senderName = currentCompany; // é€ä¿¡å…ƒ
      const recipientName = document
        .getElementById("recipientCompanyName")
        .textContent.replace("é€ä¿¡å…ˆä¼šç¤¾å: ", "")
        .trim();
      const fileInput = document.getElementById("fileInput").files[0];

      if (!recipientName || recipientName === "ï¼ˆæœªå…¥åŠ›ï¼‰" || !fileInput) {
        alert("é€ä¿¡å…ˆä¼šç¤¾ãŒç‰¹å®šã§ããªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const storageRef = storage.ref().child(`fax_files/${Date.now()}_${fileInput.name}`);
      storageRef
        .put(fileInput)
        .then((snap) => snap.ref.getDownloadURL())
        .then((url) => {
          return db2.collection("fax_messages").add({
            sender: senderName,
            recipient: recipientName,
            fileUrl: url,
            fileType: fileInput.type,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
          });
        })
        .then(() => {
          alert(`âœ… ${recipientName} ã¸ FAXã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`);
          // å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
        })
        .catch((err) => {
          console.error("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
          alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
        });
    }

    // ================================
    // å—ä¿¡ãƒ»é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆå—ä¿¡ï¼‹é€ä¿¡ã‚’çµ±åˆï¼‰
    // ================================
    function loadFaxMessages(companyName) {
      // å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼
      db2.collection("fax_messages")
        .where("recipient", "==", companyName)
        .orderBy("created_at", "desc")
        .onSnapshot((snapshot) => {
          receivedFaxes = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id;
            data.type = "å—ä¿¡";
            receivedFaxes.push(data);
          });
          updateFaxList();
        }, (error) => {
          console.error("âŒ å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ ã‚¨ãƒ©ãƒ¼:", error);
        });

      // é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼
      db2.collection("fax_messages")
        .where("sender", "==", companyName)
        .orderBy("created_at", "desc")
        .onSnapshot((snapshot) => {
          sentFaxes = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id;
            data.type = "é€ä¿¡";
            sentFaxes.push(data);
          });
          updateFaxList();
        }, (error) => {
          console.error("âŒ é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ ã‚¨ãƒ©ãƒ¼:", error);
        });
    }

    // å—ä¿¡ãƒ»é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ¼ã‚¸ã—ã¦è¡¨ç¤ºã™ã‚‹
    function updateFaxList() {
      const allMessages = receivedFaxes.concat(sentFaxes);
      // created_at ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ 0 ã¨ã—ã¦ã‚½ãƒ¼ãƒˆ
      allMessages.sort((a, b) => {
        const aTime = a.created_at ? a.created_at.toDate().getTime() : 0;
        const bTime = b.created_at ? b.created_at.toDate().getTime() : 0;
        return bTime - aTime;
      });

      const faxList = document.getElementById("faxList");
      faxList.innerHTML = "";
      allMessages.forEach((data) => {
        const timeStr = data.created_at ? data.created_at.toDate().toLocaleString() : "æ™‚é–“ä¸æ˜";
        let display = "";
        if (data.fileType === "application/pdf") {
          display = `<a href="${data.fileUrl}" target="_blank">ğŸ“„ PDFã‚’é–‹ã</a>`;
        } else {
          display = `<img src="${data.fileUrl}" width="150">`;
        }
        faxList.innerHTML += `
          <div>
            <strong>${data.type}å…ƒ:</strong> ${data.type === "å—ä¿¡" ? data.sender : data.recipient}<br>
            <strong>${data.type}å…ˆ:</strong> ${data.type === "å—ä¿¡" ? data.recipient : data.sender}<br>
            <strong>æ™‚é–“:</strong> ${timeStr}<br>
            ${display}
            <hr>
          </div>
        `;
      });
    }
  </script>
</body>
</html>
