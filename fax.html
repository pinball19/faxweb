<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>FAX送受信（会社専用）</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- PDFのサムネイル生成用 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    /* プレビュー画像・キャンバスのサイズ調整 */
    #filePreview img, #filePreview canvas {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>📠 FAX送受信（会社専用）</h1>
  <h3>現在の会社: <span id="currentCompany"></span></h3>
  <button onclick="logout()">🔲 ログアウト</button>

  <!-- 送信機能 -->
  <h1>📠 FAX送信</h1>
  <label>送信先連絡先（FAX番号／LINE ID／メールアドレス）:</label>
  <input type="text" id="recipientContact" oninput="findRecipientByContact()">
  <h3 id="recipientCompanyName">送信先会社名: （未入力）</h3>
  <input type="file" id="fileInput" accept="image/*,application/pdf">
  <div id="filePreview"></div>
  <button onclick="sendFax()">📤 送信</button>

  <!-- 受信・送信一覧（最新順） -->
  <h1>📥 送受信一覧（最新順）</h1>
  <div id="faxList"></div>

  <script>
    // ================================
    // Firebase 初期化
    // ================================
    if (!firebase.apps.length) {
      const firebaseConfig = {
        apiKey: "AIzaSyBvANDKuDIMQiCh3DcO1CUFOoMMjiAHAfw",
        authDomain: "faxweb-1250a.firebaseapp.com",
        projectId: "faxweb-1250a",
        storageBucket: "faxweb-1250a.firebasestorage.app",
        messagingSenderId: "203122177163",
        appId: "1:203122177163:web:5f7127523ad7fb364c508e",
        measurementId: "G-72STGVJ94V"
      };
      firebase.initializeApp(firebaseConfig);
    }

    const db2 = firebase.firestore();
    const storage = firebase.storage();

    // グローバル変数：受信・送信メッセージ、ログイン会社名
    let receivedFaxes = [];
    let sentFaxes = [];
    let currentCompany = "";

    // ================================
    // ページ読み込み時にログイン状態をチェック
    // ================================
    window.onload = function() {
      const companyId = sessionStorage.getItem("loggedInCompanyId");
      const companyName = sessionStorage.getItem("loggedInCompanyName");

      if (!companyId || !companyName) {
        alert("ログインが必要です。");
        window.location.href = "index.html";
        return;
      }
      currentCompany = companyName;
      document.getElementById("currentCompany").textContent = companyName;
      loadFaxMessages(companyName);
    };

    // ================================
    // ログアウト
    // ================================
    function logout() {
      sessionStorage.removeItem("loggedInCompanyId");
      sessionStorage.removeItem("loggedInCompanyName");
      window.location.href = "index.html";
    }

    // ================================
    // 送信先会社の検索（単一入力で複数条件）
    // ================================
    function findRecipientByContact() {
      const contactInput = document.getElementById("recipientContact").value.trim();
      const companyNameElem = document.getElementById("recipientCompanyName");

      if(!contactInput){
        companyNameElem.textContent = "送信先会社名: （未入力）";
        return;
      }

      db2.collection("companies")
        .get()
        .then((snapshot) => {
          let matched = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            if (
              (data.faxNumber && data.faxNumber === contactInput) ||
              (data.lineId && data.lineId === contactInput) ||
              (data.email && data.email === contactInput)
            ) {
              matched.push(data.name);
            }
          });
          companyNameElem.textContent =
            matched.length > 0
              ? `送信先会社名: ${matched.join(", ")}`
              : "送信先会社名: （該当なし）";
        })
        .catch((err) => {
          console.error("❌ 会社検索エラー:", err);
        });
    }

    // ================================
    // ファイルプレビュー（サムネイル生成）
    // ================================
    document.getElementById("fileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      const previewDiv = document.getElementById("filePreview");
      previewDiv.innerHTML = "";
      if (!file) return;

      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
      } else if (file.type === "application/pdf") {
        // PDFの場合、pdf.jsでサムネイルを生成
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
            // 最初のページを取得
            pdf.getPage(1).then(function(page) {
              const viewport = page.getViewport({ scale: 1 });
              const canvas = document.createElement("canvas");
              const context = canvas.getContext("2d");
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              page.render({
                canvasContext: context,
                viewport: viewport
              }).promise.then(function() {
                previewDiv.appendChild(canvas);
              });
            });
          });
        };
        fileReader.readAsArrayBuffer(file);
      }
    });

    // ================================
    // FAX送信処理
    // ================================
    function sendFax() {
      const senderName = currentCompany; // 送信元
      const recipientName = document
        .getElementById("recipientCompanyName")
        .textContent.replace("送信先会社名: ", "")
        .trim();
      const fileInput = document.getElementById("fileInput").files[0];

      if (!recipientName || recipientName === "（未入力）" || !fileInput) {
        alert("送信先会社が特定できないか、ファイルが選択されていません。");
        return;
      }

      const storageRef = storage.ref().child(`fax_files/${Date.now()}_${fileInput.name}`);
      storageRef
        .put(fileInput)
        .then((snap) => snap.ref.getDownloadURL())
        .then((url) => {
          return db2.collection("fax_messages").add({
            sender: senderName,
            recipient: recipientName,
            fileUrl: url,
            fileType: fileInput.type,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
          });
        })
        .then(() => {
          alert(`✅ ${recipientName} へ FAXを送信しました！`);
          // 必要に応じてフォームをクリアする処理を追加してください
        })
        .catch((err) => {
          console.error("❌ 送信エラー:", err);
          alert("送信に失敗しました");
        });
    }

    // ================================
    // 受信・送信メッセージのリアルタイム更新（受信＋送信を統合）
    // ================================
    function loadFaxMessages(companyName) {
      // 受信メッセージリスナー
      db2.collection("fax_messages")
        .where("recipient", "==", companyName)
        .orderBy("created_at", "desc")
        .onSnapshot((snapshot) => {
          receivedFaxes = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id;
            data.type = "受信";
            receivedFaxes.push(data);
          });
          updateFaxList();
        }, (error) => {
          console.error("❌ 受信メッセージリスナー エラー:", error);
        });

      // 送信メッセージリスナー
      db2.collection("fax_messages")
        .where("sender", "==", companyName)
        .orderBy("created_at", "desc")
        .onSnapshot((snapshot) => {
          sentFaxes = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id;
            data.type = "送信";
            sentFaxes.push(data);
          });
          updateFaxList();
        }, (error) => {
          console.error("❌ 送信メッセージリスナー エラー:", error);
        });
    }

    // 受信・送信メッセージをマージして表示する
    function updateFaxList() {
      const allMessages = receivedFaxes.concat(sentFaxes);
      // created_at が存在しない場合は 0 としてソート
      allMessages.sort((a, b) => {
        const aTime = a.created_at ? a.created_at.toDate().getTime() : 0;
        const bTime = b.created_at ? b.created_at.toDate().getTime() : 0;
        return bTime - aTime;
      });

      const faxList = document.getElementById("faxList");
      faxList.innerHTML = "";
      allMessages.forEach((data) => {
        const timeStr = data.created_at ? data.created_at.toDate().toLocaleString() : "時間不明";
        let display = "";
        if (data.fileType === "application/pdf") {
          display = `<a href="${data.fileUrl}" target="_blank">📄 PDFを開く</a>`;
        } else {
          display = `<img src="${data.fileUrl}" width="150">`;
        }
        faxList.innerHTML += `
          <div>
            <strong>${data.type}元:</strong> ${data.type === "受信" ? data.sender : data.recipient}<br>
            <strong>${data.type}先:</strong> ${data.type === "受信" ? data.recipient : data.sender}<br>
            <strong>時間:</strong> ${timeStr}<br>
            ${display}
            <hr>
          </div>
        `;
      });
    }
  </script>
</body>
</html>
