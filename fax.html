<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>FAXé€å—ä¿¡ï¼ˆä¼šç¤¾å°‚ç”¨ï¼‰</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <!-- PDFã®ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆç”¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <h1>ğŸ“  FAXé€å—ä¿¡ï¼ˆä¼šç¤¾å°‚ç”¨ï¼‰</h1>
    <h3>ç¾åœ¨ã®ä¼šç¤¾: <span id="currentCompany"></span></h3>
    <button onclick="logout()">ğŸ”² ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <!-- é€ä¿¡æ©Ÿèƒ½ -->
    <h1>ğŸ“  FAXé€ä¿¡</h1>
    <label>é€ä¿¡å…ˆFAXç•ªå·:</label>
    <input type="text" id="recipientFaxNumber" oninput="findRecipientByContact()">
    <label>LINE ID:</label>
    <input type="text" id="recipientLineId" oninput="findRecipientByContact()">
    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
    <input type="text" id="recipientEmail" oninput="findRecipientByContact()">
    <h3 id="recipientCompanyName">é€ä¿¡å…ˆä¼šç¤¾å: ï¼ˆæœªå…¥åŠ›ï¼‰</h3>
    <input type="file" id="fileInput" accept="image/*,application/pdf">
    <button onclick="sendFax()">ğŸ“¤ é€ä¿¡</button>

    <h1>ğŸ“¥ å—ä¿¡ä¸€è¦§ï¼ˆæœ€æ–°é †ï¼‰</h1>
    <div id="faxList"></div>

    <script>
    // ================================
    // Firebase åˆæœŸåŒ–
    // ================================
    // if (!firebase.apps.length) ... ã®å‡¦ç†ã‚’åŠ å‘³
    if (!firebase.apps.length) {
const firebaseConfig = {
  apiKey: "AIzaSyBvANDKuDIMQiCh3DcO1CUFOoMMjiAHAfw",
  authDomain: "faxweb-1250a.firebaseapp.com",
  projectId: "faxweb-1250a",
  storageBucket: "faxweb-1250a.firebasestorage.app",
  messagingSenderId: "203122177163",
  appId: "1:203122177163:web:5f7127523ad7fb364c508e",
  measurementId: "G-72STGVJ94V"
};

      firebase.initializeApp(firebaseConfig);
    }

    const db2 = firebase.firestore();
    const storage = firebase.storage();

    // ================================
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    // ================================
    window.onload = function() {
      const companyId = sessionStorage.getItem(\"loggedInCompanyId\");
      const companyName = sessionStorage.getItem(\"loggedInCompanyName\");

      if (!companyId || !companyName) {
        alert(\"ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚\");
        window.location.href = \"index.html\";
        return;
      }
      document.getElementById(\"currentCompany\").textContent = companyName;
      loadReceivedFaxes(companyName);
    };

    // ================================
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    // ================================
    function logout() {
      sessionStorage.removeItem(\"loggedInCompanyId\");
      sessionStorage.removeItem(\"loggedInCompanyName\");
      window.location.href = \"index.html\";
    }

    // ================================
    // é€ä¿¡å…ˆä¼šç¤¾ã®æ¤œç´¢
    // ================================
    function findRecipientByContact() {
      const faxNumber = document.getElementById(\"recipientFaxNumber\").value.trim();
      const lineId = document.getElementById(\"recipientLineId\").value.trim();
      const email = document.getElementById(\"recipientEmail\").value.trim();
      const companyNameElem = document.getElementById(\"recipientCompanyName\");

      db2.collection(\"companies\").get().then(snapshot => {
        let matched = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (
            (faxNumber && data.faxNumber === faxNumber) ||
            (lineId && data.lineId === lineId) ||
            (email && data.email === email)
          ) {
            matched.push(data.name);
          }
        });
        companyNameElem.textContent =
          matched.length > 0
            ? `é€ä¿¡å…ˆä¼šç¤¾å: ${matched.join(\", \")}`
            : \"é€ä¿¡å…ˆä¼šç¤¾å: ï¼ˆè©²å½“ãªã—ï¼‰\";
      }).catch(err => {
        console.error(\"âŒ ä¼šç¤¾æ¤œç´¢ã‚¨ãƒ©ãƒ¼:\", err);
      });
    }

    // ================================
    // FAXé€ä¿¡å‡¦ç†
    // ================================
    function sendFax() {
      const senderName = sessionStorage.getItem(\"loggedInCompanyName\"); // é€ä¿¡å…ƒ
      const recipientName = document
        .getElementById(\"recipientCompanyName\")
        .textContent.replace(\"é€ä¿¡å…ˆä¼šç¤¾å: \", \"\")
        .trim();
      const fileInput = document.getElementById(\"fileInput\").files[0];

      if (!recipientName || recipientName === \"ï¼ˆæœªå…¥åŠ›ï¼‰\" || !fileInput) {
        alert(\"é€ä¿¡å…ˆä¼šç¤¾ãŒç‰¹å®šã§ããªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\");
        return;
      }

      const storageRef = storage.ref().child(`fax_files/${Date.now()}_${fileInput.name}`);
      storageRef
        .put(fileInput)
        .then(snap => snap.ref.getDownloadURL())
        .then(url => {
          return db2.collection(\"fax_messages\").add({
            sender: senderName,
            recipient: recipientName,
            fileUrl: url,
            fileType: fileInput.type,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => {
          alert(`âœ… ${recipientName} ã¸ FAXã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`);
          loadReceivedFaxes(senderName);
        })
        .catch(err => {
          console.error(\"âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:\", err);
          alert(\"é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ\");
        });
    }

    // ================================
    // å—ä¿¡ä¸€è¦§ã‚’å–å¾—ï¼ˆrecipientãŒãƒ­ã‚°ã‚¤ãƒ³ä¼šç¤¾åã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ï¼‰
    // ================================
    function loadReceivedFaxes(companyName) {
      db2.collection(\"fax_messages\")
        .where(\"recipient\", \"==\", companyName)
        .orderBy(\"created_at\", \"desc\")
        .get()
        .then(snapshot => {
          const faxList = document.getElementById(\"faxList\");
          faxList.innerHTML = \"\";
          snapshot.forEach(doc => {
            const data = doc.data();
            let display = \"\";
            if (data.fileType === \"application/pdf\") {
              display = `<a href=\"${data.fileUrl}\" target=\"_blank\">ğŸ“„ PDFã‚’é–‹ã</a>`;
            } else {
              display = `<img src=\"${data.fileUrl}\" width=\"150\">`;
            }
            faxList.innerHTML += `
              <div>
                <strong>é€ä¿¡å…ƒ:</strong> ${data.sender}<br>
                <strong>é€ä¿¡å…ˆ:</strong> ${data.recipient}<br>
                ${display}
                <hr>
              </div>
            `;
          });
        })
        .catch(err => {
          console.error(\"âŒ å—ä¿¡ä¸€è¦§ã‚¨ãƒ©ãƒ¼:\", err);
        });
    }
    </script>
</body>
</html>
